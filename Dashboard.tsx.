
import React, { useState } from 'react';
import { PatientOrder } from '../types';
import { Search, CheckCircle, Clock, ChefHat, Truck, ClipboardList, LayoutGrid, X, User, MapPin } from 'lucide-react';

interface DashboardProps {
  orders: PatientOrder[];
  roomId?: string;
}

const Dashboard: React.FC<DashboardProps> = ({ orders, roomId }) => {
  const [selectedOrder, setSelectedOrder] = useState<PatientOrder | null>(null);
  const [searchTerm, setSearchTerm] = useState('');

  const stats = {
    total: orders.length,
    pending: orders.filter(o => o.status === 'ordered').length,
    cooking: orders.filter(o => o.status === 'ready_to_serve').length,
    delivering: orders.filter(o => o.status === 'delivering').length,
    done: orders.filter(o => o.status === 'delivered').length
  };

  const filtered = orders.filter(o => 
    o.patientName.includes(searchTerm) || o.roomNumber.includes(searchTerm) || o.hn.includes(searchTerm)
  );

  const formatTime = (iso?: string) => {
    if (!iso) return '-';
    return new Date(iso).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div className="space-y-6 pb-20 animate-in fade-in duration-500">
      <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
        <StatCard label="ทั้งหมด" value={stats.total} color="text-slate-800" bg="bg-white" />
        <StatCard label="รอปรุง" value={stats.pending} color="text-orange-600" bg="bg-orange-50" />
        <StatCard label="รอส่ง" value={stats.cooking} color="text-blue-600" bg="bg-blue-50" />
        <StatCard label="กำลังส่ง" value={stats.delivering} color="text-indigo-600" bg="bg-indigo-50" />
        <StatCard label="สำเร็จ" value={stats.done} color="text-emerald-600" bg="bg-emerald-50" />
      </div>

      <div className="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
        <div className="flex items-center gap-3">
          <div className="bg-indigo-100 p-2 rounded-xl text-indigo-600">
            <LayoutGrid className="w-5 h-5" />
          </div>
          <h2 className="text-xl font-bold text-slate-800">ติดตามงานแบบ Real-time</h2>
        </div>
        <div className="relative w-full md:w-80">
          <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" />
          <input 
            className="w-full pl-10 pr-4 py-3 rounded-2xl border border-slate-100 bg-slate-50 focus:ring-4 focus:ring-indigo-100 outline-none transition-all" 
            placeholder="ค้นหา ชื่อ / HN / ห้อง..." 
            value={searchTerm}
            onChange={e => setSearchTerm(e.target.value)}
          />
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-3">
          {filtered.length > 0 ? filtered.map(order => (
            <div 
              key={order.id} 
              onClick={() => setSelectedOrder(order)}
              className={`bg-white p-5 rounded-[2rem] border transition-all cursor-pointer flex justify-between items-center hover:shadow-lg ${
                selectedOrder?.id === order.id ? 'border-indigo-500 ring-4 ring-indigo-50' : 'border-slate-100'
              }`}
            >
              <div className="flex items-center gap-4">
                <StatusIcon status={order.status} />
                <div>
                  <div className="font-bold text-slate-800">{order.patientName}</div>
                  <div className="text-xs text-slate-400 flex items-center gap-2">
                    <span className="bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">ห้อง {order.roomNumber}</span>
                    <span>•</span>
                    <span>{formatTime(order.createdAt)} น.</span>
                  </div>
                </div>
              </div>
              <div className="text-right">
                <StatusBadge status={order.status} />
              </div>
            </div>
          )) : (
            <div className="bg-white rounded-[2rem] p-20 text-center border-2 border-dashed border-slate-200">
              <Search className="w-12 h-12 mx-auto mb-3 text-slate-200" />
              <p className="text-slate-400 font-medium">ไม่พบข้อมูลที่ค้นหา</p>
            </div>
          )}
        </div>

        <div className="relative">
          {selectedOrder ? (
            <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 sticky top-24 animate-in slide-in-from-right-4">
              <div className="flex justify-between items-center mb-8">
                <h3 className="font-bold text-xl text-slate-800">รายละเอียดหลักฐาน</h3>
                <button onClick={() => setSelectedOrder(null)} className="p-2 hover:bg-slate-50 rounded-full transition-colors"><X className="w-5 h-5 text-slate-400" /></button>
              </div>
              
              <div className="space-y-8">
                <TimelineStep 
                  title="สั่งอาหาร" 
                  time={formatTime(selectedOrder.createdAt)} 
                  active={true} 
                  desc={`โดย: ${selectedOrder.adminName}`} 
                  icon={<ClipboardList className="w-3 h-3" />}
                />
                <TimelineStep 
                  title="ฝ่ายครัวบันทึกเสร็จ" 
                  time={formatTime(selectedOrder.kitchen?.finishedAt)} 
                  active={!!selectedOrder.kitchen} 
                  photo={selectedOrder.kitchen?.photo} 
                  desc={`เชฟ: ${selectedOrder.kitchen?.chefName || 'รอดำเนินการ'}`}
                  icon={<ChefHat className="w-3 h-3" />}
                />
                <TimelineStep 
                  title="เสิร์ฟสำเร็จ" 
                  time={formatTime(selectedOrder.delivery?.deliveredAt)} 
                  active={!!selectedOrder.delivery} 
                  photo={selectedOrder.delivery?.photo} 
                  desc={`ผู้ส่ง: ${selectedOrder.delivery?.serverName || 'รอดำเนินการ'}`}
                  icon={<Truck className="w-3 h-3" />}
                />
              </div>

              <div className="mt-8 pt-8 border-t border-slate-50">
                <div className="flex items-center gap-3 text-sm text-slate-500">
                  <User className="w-4 h-4" />
                  <span>HN: {selectedOrder.hn}</span>
                </div>
                <div className="flex items-center gap-3 text-sm text-slate-500 mt-2">
                  <MapPin className="w-4 h-4" />
                  <span>ห้อง: {selectedOrder.roomNumber}</span>
                </div>
              </div>
            </div>
          ) : (
            <div className="bg-slate-100/50 rounded-[2.5rem] p-12 text-center text-slate-400 border-2 border-dashed border-slate-200 sticky top-24">
              <LayoutGrid className="mx-auto mb-4 w-12 h-12 opacity-10" />
              <p className="text-sm font-medium">แตะรายการด้านซ้าย<br/>เพื่อดูรูปถ่ายยืนยัน</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const StatCard = ({ label, value, color, bg }: any) => (
  <div className={`${bg} p-5 rounded-[2rem] shadow-sm border border-slate-100 transition-transform hover:scale-105`}>
    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">{label}</div>
    <div className={`text-2xl font-bold ${color}`}>{value}</div>
  </div>
);

const TimelineStep = ({ title, time, active, photo, desc, icon }: any) => (
  <div className={`relative pl-8 border-l-2 ${active ? 'border-indigo-500' : 'border-slate-100'} pb-6 last:pb-0`}>
    <div className={`absolute -left-[11px] top-0 w-5 h-5 rounded-full flex items-center justify-center border-2 ${active ? 'bg-indigo-600 border-white text-white shadow-lg' : 'bg-white border-slate-200 text-slate-300'}`}>
      {icon}
    </div>
    <div className={`text-sm font-bold ${active ? 'text-slate-800' : 'text-slate-300'}`}>{title}</div>
    <div className="text-[10px] text-slate-400 mt-0.5">{time} • {desc}</div>
    {photo && (
      <div className="mt-3 rounded-2xl overflow-hidden border border-slate-100 shadow-sm">
        <img src={photo} className="w-full h-40 object-cover" alt="Verification" />
      </div>
    )}
  </div>
);

const StatusIcon = ({ status }: { status: string }) => {
  const colors: any = {
    ordered: 'bg-orange-500',
    ready_to_serve: 'bg-blue-500',
    delivering: 'bg-indigo-500',
    delivered: 'bg-emerald-500'
  };
  return <div className={`w-2.5 h-12 rounded-full ${colors[status] || 'bg-slate-300'}`} />;
};

const StatusBadge = ({ status }: { status: string }) => {
  const config: any = {
    ordered: { text: 'รอปรุง', bg: 'bg-orange-50 text-orange-600 border-orange-100' },
    ready_to_serve: { text: 'รอส่ง', bg: 'bg-blue-50 text-blue-600 border-blue-100' },
    delivering: { text: 'กำลังส่ง', bg: 'bg-indigo-50 text-indigo-600 border-indigo-100' },
    delivered: { text: 'เสิร์ฟแล้ว', bg: 'bg-emerald-50 text-emerald-600 border-emerald-100' }
  };
  const { text, bg } = config[status] || { text: status, bg: 'bg-slate-50' };
  return <span className={`px-4 py-1.5 rounded-full text-[10px] font-bold border ${bg}`}>{text}</span>;
};

export default Dashboard;
